module.exports=[669738,a=>a.a(async(b,c)=>{try{a.s(["deleteAd",()=>r,"getAdDetail",()=>m,"getMediaFileData",()=>o,"getMovieAppMetadata",()=>n,"updateAdBudget",()=>l,"updateAdStatus",()=>k]);var d=a.i(137936),e=a.i(446129),f=a.i(559330),g=a.i(904733),h=a.i(897497),i=a.i(713095),j=b([g]);[g]=j.then?(await j)():j;let p="https://www.echiechitube.net",q=a=>{let b=new Date().getTime(),c=Math.floor(1e3*Math.random()).toString().padStart(3,"0");return`${a}-${b}-${c}`};async function k(a,b){try{let{result:c,data:d,message:g}=await (0,e.security)({readOnly:!1});if(!c||!d)return{success:!1,errMsg:g,statusCode:401};if(!a||a<=0)return{success:!1,errMsg:"Invalid advertisement ID.",statusCode:400};if(!["active","paused"].includes(b))return{success:!1,errMsg:"Invalid status.",statusCode:400};let h=await f.default.advertisement.findUnique({where:{id:a}});if(!h)return{success:!1,errMsg:"Not found.",statusCode:404};if("advertiser"===d.userType&&d.id!==h.userId)return{success:!1,errMsg:"Not permission.",statusCode:401};if("rejected"===h.status)return{success:!1,errMsg:"Rejected advertisements cannot be modified.",statusCode:400};if("active"===b&&["draft","pending"].includes(h.status))return{success:!1,errMsg:"Advertisement must be approved before activation.",statusCode:400};let i=await f.default.advertisement.update({where:{id:a},data:{status:b,updatedAt:new Date},select:{id:!0,adType:!0,status:!0,verified:!0,budget:!0,remainingBudget:!0,targetId:!0,destinationUrl:!0,mediaFileId:!0,verifiedAt:!0,createdAt:!0,updatedAt:!0,user:{select:{id:!0,name:!0,amount:!0}}}});"admin"===d.userType&&await f.default.notification.create({data:{title:`広告ステータスが変更されました`,description:`広告ID #${a} ${{active:"を再開しました",paused:"を一時停止しました"}[b]}。`,type:"advertisement",userId:h.userId}});let j={...i,adType:i.adType,budget:Number(i.budget),remainingBudget:Number(i.remainingBudget),user:{...i.user,amount:Number(i.user.amount)}};return{success:!0,data:j,errMsg:"",statusCode:200}}catch(c){let a=c instanceof Error?c.message:"Internal Server Error.",b=500;return c instanceof g.PrismaClientKnownRequestError&&"P2025"===c.code&&(a="Advertisement not found.",b=404),{success:!1,errMsg:a,statusCode:b}}}let r=async a=>{try{let{result:b,data:c,message:d}=await (0,e.security)({readOnly:!1});if(!b||!c)return{success:!1,errMsg:d,statusCode:401};let g={id:a};if("advertiser"===c.userType&&(g.userId=c.id),!await f.default.advertisement.findFirst({where:{...g},select:{id:!0}}))return{success:!1,errMsg:"Bad request.",statusCode:400};let i=await f.default.$transaction(async b=>{let d=await b.advertisement.delete({where:{id:a},select:{remainingBudget:!0,mediaFileId:!0,mediaFile:{select:{filePath:!0,filePathV2:!0}}}}),{amount:f}=await b.user.update({where:{id:c.id},data:{amount:{increment:Number(d.remainingBudget)},updatedAt:new Date},select:{amount:!0}}),g=q("ad-delete");if(await b.point.create({data:{type:"refund",amount:Number(d.remainingBudget),description:`Advertisement #${a} deletion refund`,uniqueKey:g,userId:c.id}}),d.mediaFileId&&(await b.mediaFile.delete({where:{id:d.mediaFileId}}),d.mediaFile)){let{result:a,message:b}=await (0,h.deleteFile)(d.mediaFile.filePath);if(!a)throw Error(b)}let{result:i,message:j}=await (0,e.saveAccessTokenInCookies)({...c,userType:"admin"===c.userType?"admin":"advertiser",amount:Number(f)});if(!i)throw Error(j);return Number(f)},{maxWait:1e4,timeout:25e3}).catch(a=>{throw a});return{success:!0,errMsg:"",statusCode:202,updatedAmount:i}}catch(a){return{success:!1,errMsg:a instanceof Error?a.message:"Something went wrong.",statusCode:500}}};async function l(a,b,c){try{let{result:d,data:g,message:h}=await (0,e.security)({readOnly:!1});if(!d||!g)return{success:!1,errMsg:h,statusCode:401};if(!a||a<=0)return{success:!1,errMsg:"Invalid advertisement ID.",statusCode:400};if(!["add","subtract"].includes(b))return{success:!1,errMsg:"Invalid operation.",statusCode:400};if(!c||c<=0||c>1e5)return{success:!1,errMsg:"Amount must be between 1 and 100,000 points.",statusCode:400};let i=await f.default.advertisement.findUnique({where:{id:a}});if(!i)return{success:!1,errMsg:"Not found.",statusCode:404};if("advertiser"===g.userType&&g.id!==i.userId)return{success:!1,errMsg:"Not permission.",statusCode:401};if(["deleted","rejected"].includes(i.status))return{success:!1,errMsg:"Cannot modify budget for deleted or rejected advertisements.",statusCode:400};if("add"===b){let a=await f.default.user.findUnique({where:{id:g.id},select:{amount:!0}});if(!a)return{success:!1,errMsg:"User not found.",statusCode:404};if(Number(a.amount)<c)return{success:!1,errMsg:"Insufficient point balance.",statusCode:400}}let j=q("add"===b?"budget-add":"budget-subtract"),k=await f.default.$transaction(async d=>{let f,h,i,k=await d.advertisement.findUnique({where:{id:a},select:{budget:!0,remainingBudget:!0}});if(!k)throw Error("Advertisement not found during transaction.");let l=Number(k.budget),m=Number(k.remainingBudget);"add"===b?(f=l+c,h=m+c,i=c):(i=Math.min(c,m),f=l-i,h=Math.max(0,m-i));let n=await d.advertisement.update({where:{id:a},data:{budget:f,remainingBudget:h,updatedAt:new Date},select:{id:!0,adType:!0,status:!0,verified:!0,budget:!0,remainingBudget:!0,targetId:!0,destinationUrl:!0,mediaFileId:!0,verifiedAt:!0,createdAt:!0,updatedAt:!0,user:{select:{id:!0,name:!0,amount:!0}}}});await d.point.create({data:{type:"add"===b?"consume":"refund",amount:"add"===b?-i:i,description:`Budget ${b} for advertisement #${a}`,uniqueKey:j,userId:g.id}});let{amount:o}=await d.user.update({where:{id:g.id},data:{amount:{increment:"add"===b?-i:i},updatedAt:new Date},select:{amount:!0}});n.user.amount=o;let{result:p,message:q}=await (0,e.saveAccessTokenInCookies)({...g,userType:"admin"===g.userType?"admin":"advertiser",amount:Number(o)});if(!p)throw Error(q);return n},{maxWait:1e4,timeout:25e3}).catch(a=>{throw a}),l={...k,adType:k.adType,budget:Number(k.budget),remainingBudget:Number(k.remainingBudget),user:{...k.user,amount:Number(k.user.amount)}};return{success:!0,data:l,errMsg:"",statusCode:200}}catch(c){let a=c instanceof Error?c.message:"Internal Server Error.",b=500;return c instanceof g.PrismaClientKnownRequestError&&("P2025"===c.code?(a="Advertisement not found.",b=404):"P2002"===c.code&&(a="Duplicate operation detected.",b=409)),{success:!1,errMsg:a,statusCode:b}}}async function m(a){try{let{result:b,data:c,message:d}=await (0,e.security)({readOnly:!1});if(!b||!c)return{success:!1,errMsg:d,statusCode:401};if(!a||a<=0)return{success:!1,errMsg:"Invalid advertisement ID.",statusCode:400};let g=await f.default.advertisement.findFirst({where:{id:a,userId:c.id},select:{id:!0,adType:!0,status:!0,verified:!0,budget:!0,remainingBudget:!0,targetId:!0,destinationUrl:!0,mediaFileId:!0,verifiedAt:!0,createdAt:!0,updatedAt:!0,user:{select:{id:!0,name:!0,amount:!0}}}});if(!g)return{success:!1,errMsg:"Advertisement not found.",statusCode:404};let h={...g,adType:g.adType,budget:Number(g.budget),remainingBudget:Number(g.remainingBudget),user:{...g.user,amount:Number(g.user.amount)}};return{success:!0,data:h,errMsg:"",statusCode:200}}catch(a){return{success:!1,errMsg:a instanceof Error?a.message:"Internal Server Error.",statusCode:500}}}async function n(a){try{let b=`${p}/single/${a}`,c=new AbortController,d=setTimeout(()=>c.abort(),1e4),e=await fetch(b,{method:"GET",headers:{"User-Agent":"AdService/1.0 (+https://adservice.example.com/bot)",Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","Accept-Language":"ja,en;q=0.5","Accept-Encoding":"gzip, deflate","Cache-Control":"no-cache"},signal:c.signal});if(clearTimeout(d),!e.ok){if(404===e.status)return{success:!1,data:null,errMsg:"Article not found."};throw Error(`HTTP ${e.status}: ${e.statusText}`)}let f=await e.text(),g=f.match(/<meta\s+property="og:title"\s+content="([^"]*)"[^>]*>/i)||f.match(/<title[^>]*>([^<]*)<\/title>/i),h=g?g[1].trim():`記事 #${a}`,i=f.match(/<meta\s+property="og:image"\s+content="([^"]*)"[^>]*>/i)||f.match(/<meta\s+name="twitter:image"\s+content="([^"]*)"[^>]*>/i),j=i?i[1].trim():"";if(j)if(j.startsWith("/")){let a=new URL(p);j=`${a.protocol}//${a.host}${j}`}else j.startsWith("./")?j=`${p.replace(/\/$/,"")}/${j.substring(2)}`:j.startsWith("http")||(j=`${p.replace(/\/$/,"")}/${j}`);else j=`${p.replace(/\/$/,"")}/images/default-thumbnail.jpg`;return{success:!0,data:{title:h||`記事 #${a}`,imageUrl:j,articleUrl:b},errMsg:""}}catch(b){let a="Failed to fetch article metadata.";return b instanceof Error&&(a="AbortError"===b.name?"Request timeout: Article metadata fetch took too long.":b.message.includes("fetch")?"Network error: Unable to connect to movieApp.":b.message),console.error("MovieApp metadata fetch error:",b),{success:!1,data:null,errMsg:a}}}async function o(a){try{let b=await f.default.mediaFile.findUnique({where:{id:a},select:{id:!0,filePath:!0,filePathV2:!0,mimeType:!0,fileSize:!0,destination:!0}});if(!b)return{success:!1,data:null,errMsg:"Media file not found."};return{success:!0,data:{id:b.id,filePath:b.filePath,filePathV2:b.filePathV2,mimeType:b.mimeType,fileSize:b.fileSize,destination:b.destination},errMsg:""}}catch(a){return console.error("MediaFile fetch error:",a),{success:!1,data:null,errMsg:a instanceof Error?a.message:"MediaFile fetch error."}}}(0,i.ensureServerEntryExports)([k,r,l,m,n,o]),(0,d.registerServerReference)(k,"60f22a9d0ebe1329f0090b9a4e074ef2b2a42b975c",null),(0,d.registerServerReference)(r,"7f4de78c96a2d1d1b748d94043f2b0340cf350b4db",null),(0,d.registerServerReference)(l,"707241b5525271d4bb599ee9237a1bc22f2f8a15ee",null),(0,d.registerServerReference)(m,"4055901fe9a31d11b102112774ac8af526cd1c06ad",null),(0,d.registerServerReference)(n,"40e0dd0c8f51903f6c9dbde10fd8a85774f8a32c6d",null),(0,d.registerServerReference)(o,"402352c20389aa79c9626848528eb766baafea9309",null),c()}catch(a){c(a)}},!1),139860,a=>{"use strict";a.s(["reviewAction",()=>g],139860);var b=a.i(137936),c=a.i(446129),d=a.i(897497),e=a.i(559330);let f={inappropriate_content:"投稿された内容が当サービスのガイドラインに適さないため、掲載を見送らせていただきました。",misleading_information:"広告内容に誤解を招く表現が含まれているため、修正が必要です。",copyright_violation:"著作権に関する問題が確認されたため、掲載できません。",technical_issues:"技術的な問題により正常に表示されないため、再作成をお願いします。",policy_violation:"当サービスの広告ポリシーに違反する内容が含まれています。",poor_quality:"広告の品質基準を満たしていないため、改善が必要です。",invalid_target:"指定されたターゲットが無効または存在しないため、確認をお願いします。",broken_links:"リンク先にアクセスできないため、URLの確認をお願いします。",other:"審査の結果、掲載を見送らせていただくことになりました。"};async function g({adminId:a,adId:b,action:g,reason:h,comment:i}){console.log("--reviewAction--");try{let{result:j,data:k,message:l}=await (0,c.security)({readOnly:!1});if(!j||!k)return{success:!1,errMsg:l,statusCode:401};if("admin"!==k.userType||k.id!==a)return{success:!1,errMsg:"Access denied.",statusCode:403};let m=await e.default.advertisement.findUnique({where:{id:b},select:{remainingBudget:!0,userId:!0,mediaFile:{select:{id:!0,filePath:!0}}}});if(!m)return{success:!1,errMsg:"Not found.",statusCode:404};return console.log("x1"),await e.default.$transaction(async a=>{if("approve"===g)await a.advertisement.update({where:{id:b},data:{status:"active",verified:!0,verifiedAt:new Date,updatedAt:new Date},include:{user:{select:{id:!0,name:!0,amount:!0}}}}),await a.notification.create({data:{userId:m?.userId,title:"広告が承認されました",description:`
                            広告「ID:${b}」が承認され、配信を開始いたします。
                            ${i?`

【メッセージ】
${i}`:""}
                        `,type:"advertisement",isRead:!1}});else if("reject"===g){let c=Number(m.remainingBudget);c>0&&(await a.user.update({where:{id:m.userId},data:{amount:{increment:c}}}),await a.point.create({data:{userId:m.userId,type:"refund",amount:c,description:`Ad rejected and deleted - refund for ad #${b}`,uniqueKey:`refund-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}})),await a.advertisement.delete({where:{id:b}});let e=h?f[h]:f.other,g=`
                    広告「ID:${b}」は審査の結果、却下となり削除されました。

【却下理由】
${e}
                    ${i?`

【追加メッセージ】
${i}`:""}
                    ${c>0?`

使用済みポイント ${c}P を返還いたしました。`:""}
                `;if(await a.notification.create({data:{userId:m.userId,title:"広告が却下されました",description:g,type:"advertisement",isRead:!1}}),m.mediaFile){await a.mediaFile.delete({where:{id:m.mediaFile.id}});let b=m.mediaFile.filePath,{result:c,message:e}=await (0,d.deleteFile)(b);if(!c)throw Error(e)}}},{maxWait:1e4,timeout:25e3}).catch(a=>{throw a}),console.log("x2"),{success:!0,errMsg:"",statusCode:200}}catch(a){return console.error("Review action error:",a),{success:!1,errMsg:a instanceof Error?a.message:"Internal Server Error.",statusCode:500}}}(0,a.i(713095).ensureServerEntryExports)([g]),(0,b.registerServerReference)(g,"40673a8647bf44d7cc5d734ebb72c80408d66eb271",null)}];

//# sourceMappingURL=src_actions_ad_d0b0e699._.js.map